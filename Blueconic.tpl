___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "CLIENT",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Blueconic",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,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"
  },
  "description": "Use this Client as a mapper from Request Data to Event Data.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "CHECKBOX",
    "name": "exposeFPIDCookie",
    "checkboxText": "Expose FPID Cookie",
    "simpleValueType": true,
    "help": "If enabled, the server only accessible FPID cookie, generated by UA/GA4 client, will be duplicated to FPIDP cookie, which will be accessible from the client JS. Highly recommend using this option only in case it is necessary."
  },
  {
    "type": "CHECKBOX",
    "name": "generateClientId",
    "checkboxText": "Always generate client_id parameter",
    "simpleValueType": true,
    "help": "If enabled, even if the `client_id` parameter will not be determined from the request, it will still be generated. The `client_id` parameter is required by UA/GA4 tags.",
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "prolongCookies",
    "checkboxText": "Automatically prolong Data Tag cookies",
    "simpleValueType": true,
    "help": "If enabled, cookies generated by Data tag will be reseated from the server with an expiration time of two years. Useful if you use Data tag store functionality.",
    "defaultValue": true
  },
  {
    "type": "GROUP",
    "name": "responseSettings",
    "displayName": "Response Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "responseBody",
        "displayName": "Response Body",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "timestamp",
            "displayValue": "JSON Object with timestamp (recommended)"
          },
          {
            "value": "eventData",
            "displayValue": "JSON Object with Event Data"
          },
          {
            "value": "empty",
            "displayValue": "Empty"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "timestamp"
      },
      {
        "type": "CHECKBOX",
        "name": "responseBodyGet",
        "checkboxText": "Send Response Body for GET request",
        "simpleValueType": true,
        "help": "By default, for the GET request type, the answer is image pixel.  \u003ca target\u003d\"_blank\" href\u003d\"https://developers.google.com/tag-manager/serverside/api#setpixelresponse\"\u003eMore Info\u003c/a\u003e."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "pathSettings",
    "displayName": "Accepted Path Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "path",
        "displayName": "Type additional paths that will be claimed by this client",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "For example: /callback",
            "name": "path",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "newRowButtonText": "Add path",
        "help": "By default path \u003cb\u003e/data\u003c/b\u003e will be claimed. But you can add more paths that will be claimed by this client."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const returnResponse = require('returnResponse');
const runContainer = require('runContainer');
const setResponseHeader = require('setResponseHeader');
const setResponseStatus = require('setResponseStatus');
const setResponseBody = require('setResponseBody');
const JSON = require('JSON');
const fromBase64 = require('fromBase64');
const getTimestampMillis = require('getTimestampMillis');
const getCookieValues = require('getCookieValues');
const getRequestBody = require('getRequestBody');
const getRequestMethod = require('getRequestMethod');
const getRequestHeader = require('getRequestHeader');
const getRequestPath = require('getRequestPath');
const getRequestQueryParameters = require('getRequestQueryParameters');
const makeInteger = require('makeInteger');
const getRemoteAddress = require('getRemoteAddress');
const setCookie = require('setCookie');
const setPixelResponse = require('setPixelResponse');
const generateRandom = require('generateRandom');
const computeEffectiveTldPlusOne = require('computeEffectiveTldPlusOne');

const requestMethod = getRequestMethod();
const path = getRequestPath();
let isClientUsed = false;

if (path === '/data') {
    runClient();
}

if (data.path && !isClientUsed) {
    for (let key in data.path) {
        if (!isClientUsed && data.path[key].path === path) {
            runClient();
        }
    }
}

function runClient() {
    isClientUsed = true;
    require('claimRequest')();

    if (requestMethod === 'OPTIONS') {
        setResponseHeaders();
        returnResponse();

        return;
    }

    let eventModel = {
        timestamp: makeInteger(getTimestampMillis() / 1000),
        unique_event_id: getTimestampMillis() + '_' + generateRandom(100000000, 999999999)
    };

    eventModel = addQueryParametersToEventModel(eventModel);
    eventModel = addBodyParametersToEventModel(eventModel);
    eventModel = addRequiredParametersToEventModel(eventModel);
    eventModel = addCommonParametersToEventModel(eventModel);
    eventModel = addClientIdToEventModel(eventModel);
    storeClientId(eventModel);
    exposeFPIDCookie(eventModel);
    prolongDataTagCookies(eventModel);
    setResponseHeaders();

    runContainer(eventModel, () => {
        if (requestMethod === 'POST' || data.responseBodyGet) {
            prepareResponseBody(eventModel);
            returnResponse();
        } else {
            setPixelResponse();
            returnResponse();
        }
    });
}

function addCommonParametersToEventModel(eventModel) {
    let userData = {};
    let userAddressData = {};

    if (eventModel.user_data) userData = eventModel.user_data;
    if (userData.address) userAddressData = userData.address;

    if (!eventModel.ip_override) {
        if (eventModel.ip) eventModel.ip_override = eventModel.ip;
        else if (eventModel.ipOverride) eventModel.ip_override = eventModel.ipOverride;
        else eventModel.ip_override = getRemoteAddress();
    }

    if (!eventModel.user_agent) {
        if (eventModel.userAgent) eventModel.user_agent = eventModel.userAgent;
        else if (getRequestHeader('User-Agent')) eventModel.user_agent = getRequestHeader('User-Agent');
    }

    if (!eventModel.language) {
        const acceptLanguageHeader = getRequestHeader('Accept-Language');

        if (acceptLanguageHeader) {
            eventModel.language = acceptLanguageHeader.split(';')[0].substring(0, 2).toLowerCase();
        }
    }

    if (!eventModel.page_hostname) {
        if (eventModel.pageHostname) eventModel.page_hostname = eventModel.pageHostname;
        else if (eventModel.hostname) eventModel.page_hostname = eventModel.hostname;
    }

    if (!eventModel.page_location) {
        if (eventModel.pageLocation) eventModel.page_location = eventModel.pageLocation;
        else if (eventModel.url) eventModel.page_location = eventModel.url;
        else if (eventModel.href) eventModel.page_location = eventModel.href;
    }

    if (!eventModel.page_referrer) {
        if (eventModel.pageReferrer) eventModel.page_referrer = eventModel.pageReferrer;
        else if (eventModel.referrer) eventModel.page_referrer = eventModel.referrer;
    }

    if (eventModel.items && eventModel.items[0]) {
        if (!eventModel.currency && eventModel.items[0].currency) eventModel.currency = eventModel.items[0].currency;

        if (!eventModel.items[1]) {
            if (!eventModel.item_id && eventModel.items[0].item_id) eventModel.item_id = eventModel.items[0].item_id;
            if (!eventModel.item_name && eventModel.items[0].item_name) eventModel.item_name = eventModel.items[0].item_name;
            if (!eventModel.item_brand && eventModel.items[0].item_brand) eventModel.item_brand = eventModel.items[0].item_brand;
            if (!eventModel.item_quantity && eventModel.items[0].quantity) eventModel.item_quantity = eventModel.items[0].quantity;
            if (!eventModel.item_category && eventModel.items[0].item_category) eventModel.item_category = eventModel.items[0].item_category;

            if (eventModel.items[0].price) {
                if (!eventModel.item_price) eventModel.item_price = eventModel.items[0].price;
                if (!eventModel.value) eventModel.value = eventModel.items[0].quantity ? eventModel.items[0].quantity * eventModel.items[0].price : eventModel.items[0].price;
            }
        } else if (!eventModel.value) {
            let valueFromItems = 0;

            eventModel.items.forEach((d) => {
                if (d.price) valueFromItems += d.quantity ? d.quantity * d.price : d.price;
            });

            if (valueFromItems) eventModel.value = valueFromItems;
        }
    }

    const ecommerceAction = getEcommerceAction(eventModel);

    if (ecommerceAction) {
        if (!eventModel['x-ga-mp1-pa']) eventModel['x-ga-mp1-pa'] = ecommerceAction;

        if (ecommerceAction === 'purchase' && eventModel.ecommerce.purchase.actionField) {
            if (!eventModel['x-ga-mp1-tr']) eventModel['x-ga-mp1-tr'] = eventModel.ecommerce.purchase.actionField.revenue;
            if (!eventModel.revenue) eventModel.revenue = eventModel.ecommerce.purchase.actionField.revenue;
            if (!eventModel.affiliation) eventModel.affiliation = eventModel.ecommerce.purchase.actionField.affiliation;
            if (!eventModel.tax) eventModel.tax = eventModel.ecommerce.purchase.actionField.tax;
            if (!eventModel.shipping) eventModel.shipping = eventModel.ecommerce.purchase.actionField.shipping;
            if (!eventModel.coupon) eventModel.coupon = eventModel.ecommerce.purchase.actionField.coupon;
            if (!eventModel.transaction_id) eventModel.transaction_id = eventModel.ecommerce.purchase.actionField.id;
        }
    }

    if (!userData.email_address) {
        if (eventModel.userEmail) userData.email_address = eventModel.userEmail;
        else if (eventModel.email_address) userData.email_address = eventModel.email_address;
        else if (eventModel.email) userData.email_address = eventModel.email;
        else if (eventModel.mail) userData.email_address = eventModel.mail;
    }

    if (!userData.phone_number) {
        if (eventModel.userPhoneNumber) userData.phone_number = eventModel.userPhoneNumber;
        else if (eventModel.phone_number) userData.phone_number = eventModel.phone_number;
        else if (eventModel.phoneNumber) userData.phone_number = eventModel.phoneNumber;
        else if (eventModel.phone) userData.phone_number = eventModel.phone;
    }

    if (!eventModel.page_encoding && eventModel.pageEncoding) eventModel.page_encoding = eventModel.pageEncoding;
    if (!eventModel.page_path && eventModel.pagePath) eventModel.page_path = eventModel.pagePath;
    if (!eventModel.page_title && eventModel.pageTitle) eventModel.page_title = eventModel.pageTitle;
    if (!eventModel.screen_resolution && eventModel.screenResolution) eventModel.screen_resolution = eventModel.screenResolution;
    if (!eventModel.viewport_size && eventModel.viewportSize) eventModel.viewport_size = eventModel.viewportSize;
    if (!eventModel.user_id && eventModel.userId) eventModel.user_id = eventModel.userId;
    if (!userAddressData.street && eventModel.street) userAddressData.street = eventModel.street;
    if (!userAddressData.city && eventModel.city) userAddressData.city = eventModel.city;
    if (!userAddressData.region && eventModel.region) userAddressData.region = eventModel.region;
    if (!userAddressData.country && eventModel.country) userAddressData.country = eventModel.country;

    if (!userAddressData.first_name) {
        if (eventModel.userFirstName) userAddressData.first_name = eventModel.userFirstName;
        else if (eventModel.first_name) userAddressData.first_name = eventModel.first_name;
        else if (eventModel.firstName) userAddressData.first_name = eventModel.firstName;
        else if (eventModel.name) userAddressData.first_name = eventModel.name;
    }

    if (!userAddressData.last_name) {
        if (eventModel.userLastName) userAddressData.last_name = eventModel.userLastName;
        else if (eventModel.last_name) userAddressData.last_name = eventModel.last_name;
        else if (eventModel.lastName) userAddressData.last_name = eventModel.lastName;
        else if (eventModel.surname) userAddressData.last_name = eventModel.surname;
        else if (eventModel.family_name) userAddressData.last_name = eventModel.family_name;
        else if (eventModel.familyName) userAddressData.last_name = eventModel.familyName;
    }

    if (!userAddressData.region) {
        if (eventModel.region) userAddressData.region = eventModel.region;
        else if (eventModel.state) userAddressData.region = eventModel.state;
    }

    if (!userAddressData.postal_code) {
        if (eventModel.postal_code) userAddressData.postal_code = eventModel.postal_code;
        else if (eventModel.postalCode) userAddressData.postal_code = eventModel.postalCode;
        else if (eventModel.zip) userAddressData.postal_code = eventModel.zip;
    }

    if (getObjectLength(userAddressData) !== 0) {
        userData.address = userAddressData;
    }

    if (getObjectLength(userData) !== 0) {
        eventModel.user_data = userData;
    }

    return eventModel;
}

function addQueryParametersToEventModel(eventModel) {
    const requestQueryParameters = getRequestQueryParameters();

    if (requestQueryParameters) {
        for (let queryParameterKey in requestQueryParameters) {
            if ((queryParameterKey === 'dtcd' || queryParameterKey === 'dtdc') && requestMethod === 'GET') {
                let dt = queryParameterKey === 'dtcd' ? JSON.parse(requestQueryParameters[queryParameterKey]) : JSON.parse(fromBase64(requestQueryParameters[queryParameterKey]));

                for (let dtKey in dt) {
                    eventModel[dtKey] = dt[dtKey];
                }
            } else {
                eventModel[queryParameterKey] = requestQueryParameters[queryParameterKey];
            }
        }
    }

    return eventModel;
}

function addClientIdToEventModel(eventModel) {
    if (eventModel.client_id) return eventModel;

    if (eventModel.data_client_id) eventModel.client_id = eventModel.data_client_id;
    else if (eventModel._dcid) eventModel.client_id = eventModel._dcid;
    else if (getCookieValues('_dcid') && getCookieValues('_dcid')[0]) eventModel.client_id = getCookieValues('_dcid')[0];
    else if (data.generateClientId) eventModel.client_id = 'dcid.1.' + getTimestampMillis() + '.' + generateRandom(100000000, 999999999);

    return eventModel;
}

function addBodyParametersToEventModel(eventModel) {
    const body = getRequestBody();

    if (body) {
        const bodyJson = JSON.parse(body);

        if (bodyJson) {
            for (let bodyKey in bodyJson) {
                eventModel[bodyKey] = bodyJson[bodyKey];
            }
        }
    }

    return eventModel;
}

function prolongDataTagCookies(eventModel) {
    if (data.prolongCookies) {
        let stapeData = getCookieValues('stape');

        if (stapeData.length) {
            setCookie('stape', stapeData[0], {
                domain: 'auto',
                path: '/',
                samesite: getCookieType(eventModel),
                secure: true,
                'max-age': 63072000, // 2 years
                httpOnly: false
            });
        }
    }
}

function addRequiredParametersToEventModel(eventModel) {
    if (!eventModel.event_name) {
        let eventName = 'Data';

        if (eventModel.eventName) eventName = eventModel.eventName;
        else if (eventModel.event) eventName = eventModel.event;

        eventModel.event_name = eventName;
    }

    return eventModel;
}

function exposeFPIDCookie(eventModel) {
    if (data.exposeFPIDCookie) {
        let fpid = getCookieValues('FPID');

        if (fpid.length) {
            setCookie('FPIDP', fpid[0], {
                domain: 'auto',
                path: '/',
                samesite: getCookieType(eventModel),
                secure: true,
                'max-age': 63072000, // 2 years
                httpOnly: false
            });
        }
    }
}

function storeClientId(eventModel) {
    if (data.generateClientId) {
        setCookie('_dcid', eventModel.client_id, {
            domain: 'auto',
            path: '/',
            samesite: getCookieType(eventModel),
            secure: true,
            'max-age': 63072000, // 2 years
            httpOnly: false
        });
    }
}

function getObjectLength(object) {
    let length = 0;

    for (let key in object) {
        if (object.hasOwnProperty(key)) {
            ++length;
        }
    }
    return length;
}

function setResponseHeaders() {
    setResponseHeader('Access-Control-Max-Age', '600');
    setResponseHeader('Access-Control-Allow-Origin', getRequestHeader('origin'));
    setResponseHeader('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS');
    setResponseHeader('Access-Control-Allow-Headers', 'content-type,set-cookie,x-robots-tag,x-gtm-server-preview,x-stape-preview');
    setResponseHeader('Access-Control-Allow-Credentials', 'true');
    setResponseStatus(200);
}

function getCookieType(eventModel) {
    if (!eventModel.page_location) {
        return 'Lax';
    }

    const host = getRequestHeader('host');
    const effectiveTldPlusOne = computeEffectiveTldPlusOne(eventModel.page_location);

    if (!host || !effectiveTldPlusOne) {
        return 'Lax';
    }

    if (host && host.indexOf(effectiveTldPlusOne) !== -1) {
        return 'Lax';
    }

    return 'None';
}

function prepareResponseBody(eventModel) {
    if (data.responseBody === 'empty') {
        return;
    }

    setResponseHeader('Content-Type', 'application/json');

    if (data.responseBody === 'eventData') {
        setResponseBody(JSON.stringify(eventModel));

        return;
    }

    setResponseBody(JSON.stringify({
        timestamp: eventModel.timestamp,
        unique_event_id: eventModel.unique_event_id,
    }));
}

function getEcommerceAction(eventModel) {
    if (eventModel.ecommerce) {
        const actions = ['detail', 'click', 'add', 'remove', 'checkout', 'checkout_option', 'purchase', 'refund'];

        for (let index = 0; index < actions.length; ++index) {
            const action = actions[index];

            if (eventModel.ecommerce[action]) {
                return action;
            }
        }
    }

    return null;
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "return_response",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_response",
        "versionId": "1"
      },
      "param": [
        {
          "key": "writeResponseAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "writeHeaderAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "run_container",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "blueconic"
              },
              {
                "type": 1,
                "string": "_dcid"
              },
              {
                "type": 1,
                "string": "FPIDP"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "set_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedCookies",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "blueconic"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_dcid"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "name"
                  },
                  {
                    "type": 1,
                    "string": "domain"
                  },
                  {
                    "type": 1,
                    "string": "path"
                  },
                  {
                    "type": 1,
                    "string": "secure"
                  },
                  {
                    "type": 1,
                    "string": "session"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "FPIDP"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  },
                  {
                    "type": 1,
                    "string": "any"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 21/03/2021, 11:24:30


